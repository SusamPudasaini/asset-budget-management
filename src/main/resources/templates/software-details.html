<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ne">
<head>
    <meta charset="UTF-8">
    <title>सफ्टवेयर विवरण</title>
    <link rel="stylesheet" th:href="@{/css/SoftwareDetailsStyle.css}">
    <link rel="stylesheet" th:href="@{/css/Style.css}" />
</head>
<body>

<header>
    <div th:replace="fragments/navbar :: navbar"></div>
    <div th:replace="fragments/sidebar :: sidebar"></div>
</header>

<main>
	<div class="btn-container">
	    <a id="backBtn" class="back-btn" href="#">
	        <i class="fa fa-arrow-left"></i> Back
	    </a>
	    <button id="downloadBtn" class="download-btn" style="display:none;">
	        <i class="fa fa-download"></i> Download Source Code
	    </button>
	</div>

    <section>
        <h1>Software Name: <span id="softwareName">-</span></h1>

        <div class="details-container">
            <!-- All detail items (unchanged) -->
            <div class="detail-item"><div class="detail-label"><i class="fa fa-briefcase"></i> प्रयोग गर्ने विभाग</div><div class="detail-value" id="department"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-align-left"></i> सफ्टवेयरको प्रयोजन / कार्य</div><div class="detail-value" id="softwareDescription"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-building"></i> निर्माण संस्था / कम्पनी</div><div class="detail-value" id="company"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-layer-group"></i> स्वीकृत तह</div><div class="detail-value" id="approvalLevel"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-calendar-check"></i> स्वीकृत मिति</div><div class="detail-value" id="approvalDate"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-calendar-day"></i> संचालन मिति</div><div class="detail-value" id="operationDate"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-money-bill"></i> खरिद रकम</div><div class="detail-value" id="purchaseAmount"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-redo"></i> नविकरण मिति</div><div class="detail-value" id="renewalDate"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-calendar-times"></i> समाप्त मिति</div><div class="detail-value" id="expiryDate"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-handshake"></i> Support विभाग</div><div class="detail-value" id="supportDepartment"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-toggle-on"></i> स्थिति</div><div class="detail-value" id="status"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-building-columns"></i> AMC कम्पनी</div><div class="detail-value" id="amcCompany"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-calendar-plus"></i> पछिल्लो भुक्तानी मिति</div><div class="detail-value" id="lastPaidDate"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-calendar-minus"></i> तिर्नुपर्ने मिति</div><div class="detail-value" id="dueDate"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-link"></i> CBS Integration</div><div class="detail-value" id="cbsIntegrated"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-server"></i> Server Space (GB)</div><div class="detail-value" id="serverSpace"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-shield-alt"></i> सुरक्षात्मक उपाय</div><div class="detail-value" id="securityMeasures"></div></div>
            <div class="detail-item"><div class="detail-label"><i class="fa fa-sticky-note"></i> कैफियत</div><div class="detail-value" id="remarks"></div></div>
        </div>
    </section>
</main>

<script>
(async () => {
    const urlParams = new URLSearchParams(window.location.search);
	
    const softwareId = urlParams.get('id');
    if (!softwareId) return;

    try {
        const response = await fetch(`http://localhost:8082/api/software/${softwareId}`);
        if (!response.ok) throw new Error('Software not found');
        const data = await response.json();

        // ✅ Fill all fields dynamically
        const fields = [
            "softwareName", "department", "softwareDescription", "company", "approvalLevel",
            "approvalDate", "operationDate", "purchaseAmount", "renewalDate", "expiryDate",
            "supportDepartment", "status", "amcCompany", "lastPaidDate", "dueDate",
            "cbsIntegrated", "serverSpace", "securityMeasures", "remarks"
        ];
        fields.forEach(field => {
            document.getElementById(field).textContent = data[field] || '-';
        });

        // ✅ Enable download if source code exists
        const downloadBtn = document.getElementById("downloadBtn");
        if (data.sourceCodeName) {
            downloadBtn.style.display = "inline-block";
            downloadBtn.onclick = async () => {
                const downloadUrl = `http://localhost:8082/api/software/${softwareId}/download`;

                try {
                    const fileResponse = await fetch(downloadUrl);
                    if (!fileResponse.ok) throw new Error("File not found");

                    const blob = await fileResponse.blob();
                    const filename =
                        data.sourceCodeName ||
                        fileResponse.headers.get("Content-Disposition")?.split("filename=")[1]?.replace(/"/g, "") ||
                        "source_code.zip";

                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    URL.revokeObjectURL(link.href);
                } catch (error) {
                    console.error("Download failed:", error);
                    alert("फाइल डाउनलोड गर्न समस्या भयो!");
                }
            };
        }
		
		// ✅ Set back button dynamically
		if (data.isDeleted === 1 || data.isDeleted === true) {
		    backBtn.href = "/software/deleted-list";
		} else {
		    backBtn.href = "/software/list";
		}
		
    } catch (error) {
        console.error("Error fetching software details:", error);
        alert("सफ्टवेयर विवरण लोड गर्न असफल भयो!");
    }
})();
</script>

<script th:src="@{/js/script.js}"></script>

</body>
</html>
