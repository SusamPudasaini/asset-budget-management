<!DOCTYPE html>
<html lang="ne" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>कृषि विकास बैंक</title>
  <link rel="stylesheet" th:href="@{/css/Style.css}" />
  <link rel="stylesheet" th:href="@{/css/asset-applicationStyle.css}">
  <style>
    body {
      background-color: white;
    }
  </style>
</head>
<body>
  <header>
    <div th:replace="fragments/navbar :: navbar"></div>
    <div th:replace="fragments/sidebar :: sidebar"></div>
  </header>

  <!-- Load Memo Form -->
  <form th:action="@{/asset-application/new}" method="get" class="load-application">
    <input type="text" name="appNumber" placeholder="e.g. 2082/83-007" />
    <button type="submit">Load Memo</button>
  </form>

  <!-- User Actions -->
  <div class="user-actions">
    <a th:href="@{/asset-application/new}">
      <button class="print-btn">New Memo</button>
    </a>
    <button class="print-btn" onclick="window.print()">Print Sample</button>
  </div>

  <!-- Messages -->
  <div th:if="${successMessage}" class="success-msg" th:text="${successMessage}"></div>
  <div th:if="${errorMessage}" class="error-msg" th:text="${errorMessage}"></div>

  <!-- Application Form -->
  <form th:action="@{/asset-application/save}" method="post" th:object="${applicationDetails}">
    <!-- Letter Head -->
    <div class="letter-head">
      <div>
        <h1>
          <img th:src="@{/images/ADBL-LOGO-CIRCLE.png}" alt="कृषि विकास बैंक लोगो" class="logo">
          कृषि विकास बैंक लिमिटेड
        </h1>
        <div>सूचना प्रविधि विभाग, मुख्य कार्यालय</div>
        <div>फोन नं.: ०१-४२१७०३९ Email: it.divn@adbl.gov.np</div>
      </div>
    </div>

    <!-- Application Info -->
    <div class="application-info">
      <div class="info-row">
        <div class="info-pair">
          <div class="title">लाई: </div>
          <div class="value">
            <input type="text" th:field="*{toWhom}" class="printable-input nepali-preeti" required>
          </div>
        </div>
        <div class="info-pair">
          <div class="title">आ.प.नं:</div>
          <div class="value">
			<input type="text" th:field="*{applicationNumber}" class="printable-input nepali-himali">
          </div>
        </div>
      </div>

      <div class="info-row">
        <div class="info-pair">
          <div class="title">बाट: </div>
          <div class="value">
            <input type="text" th:field="*{fromWhom}" class="printable-input" required>
          </div>
        </div>
        <div class="info-pair">
          <div class="title" style="margin-left: 12px;">मिति:</div>
          <div class="value">
            <input type="text" th:field="*{date}" class="printable-input nepali-himali" required>
          </div>
        </div>
      </div>

      <div class="info-row">
        <div class="info-pair">
          <div class="title">विषय:</div>
          <div class="value">
            <input type="text" th:field="*{subject}" class="printable-input nepali-preeti" required>
          </div>
        </div>
        <div class="info-pair">
          <div class="title">बोधार्थ:</div>
          <div class="value">
            <input type="text" th:field="*{cc}" class="printable-input nepali-preeti">
          </div>
        </div>
      </div>
    </div>

    <!-- व्यहोरा -->
    <h3>व्यहोरा</h3>
    <p id="recommendationText">
      प्रदेश कार्यालयको सिफारिस अनुसार तपशिल अनुसारको सामान वा आवश्यक बजेट व्यवस्थाको लागि
      सिफारिस गरिएको व्यहोरा अनुरोध छ ।
    </p>

	<!-- Items Table -->
	<table id="info-Table">
	  <thead>
	    <tr>
	      <th>क.सं.</th>
	      <th>कार्यालयको नाम</th>
	      <th>सामानको विवरण</th>
	      <th>थान</th>
	      <th>रकम</th>
	      <th>माग भइ <br> आएको रकम</th>
	      <th>कैफियत</th>
	      <th>Action</th>
	    </tr>
	  </thead>
	  <tbody>
	    <tr th:each="item, iterStat : *{assetHistories}">
	      <td style="font-family: 'Himali';" th:text="${iterStat.index + 1}"></td>
	      <td class="printable-input">
	        <div class="branch-select-wrapper">
	          <select th:field="*{assetHistories[__${iterStat.index}__].branch.branchCode}" required
	                  th:onchange="this.nextElementSibling.textContent=this.options[this.selectedIndex].text">
	            <option value="" selected>-- शाखा चयन गर्नुहोस् --</option>
	            <option th:each="branch : ${branches}"
	                    th:value="${branch.branchCode}"
	                    th:text="${branch.branchNameNepali + ' (' + branch.provinceCode.provinceNameNepali + ')'}">
	            </option>
	          </select>
	          <span class="branch-print-text"></span>
	        </div>
	      </td>
	      <td><input type="text" th:field="*{assetHistories[__${iterStat.index}__].itemDetails}" class="printable-input"></td>
	      <td><input type="text" th:field="*{assetHistories[__${iterStat.index}__].quantity}" class="printable-input quantity"></td>
	      <td><input type="text" step="0.01" th:field="*{assetHistories[__${iterStat.index}__].amount}" class="printable-input number"></td>
	      <td><input type="text" step="0.01" th:field="*{assetHistories[__${iterStat.index}__].requestedAmount}" class="printable-input number requested-amount"></td>
	      <td><textarea th:field="*{assetHistories[__${iterStat.index}__].remark}" class="printable-textarea"></textarea></td>
	      <td><button type="button" class="removeRowBtn">-</button></td>
	    </tr>
	  </tbody>
	</table>
	<button id="addRowBtn" type="button">+</button>

    <!-- Signature -->
    <div class="signature">
      <div class="sig-row">
        <div class="title">दस्तखत :</div>
        <div class="value">.................</div>
      </div>
      <div class="sig-row">
        <div class="title">पठाउने कर्मचारीको नामथर :</div>
        <div class="value">गिरी राज रेग्मी</div>
      </div>
      <div class="sig-row">
        <div class="title">पद, कोड नं.::</div>
        <div class="value">विभागीय प्रमुख, ५५३९</div>
      </div>
    </div>
	
	<div class="signature" style="display:none">
		<div class="sig-row">
		        <div class="title">दस्तखत :</div>
		        <div class="value"><input type="text" class="printable-input"></div>
		</div>
	  <div class="sig-row">
	    <div class="title">पठाउने कर्मचारीको नामथर :</div>
	    <div class="value"><input type="text" th:field="*{staffFullName}" class="printable-input" required></div>
	  </div>
	  <div class="sig-row">
	    <div class="title">पद:</div>
	    <div class="value"><input type="text" th:field="*{staffPost}" class="printable-input" required></div>
	  </div>
	  <div class="sig-row">
	    <div class="title">कोड नं. :</div>
	    <div class="value"><input type="text" th:field="*{staffCode}" class="printable-input" required></div>
	  </div>
	</div>

    <!-- Save button -->
    <div class="save-btn" style="margin-top:20px;">
      <button type="submit">Save</button>
    </div>
  </form>

  <!-- Search Section -->
  <div class="search-section">
    <h2>बिगतमा मागीएका सामान:</h2>
    <div style="margin:20px 0;">
      <label for="branchSearch">
        <i class="fas fa-search-location" style="color:#2e7d32; margin-right:5px;"></i> शाखा खोज्नुहोस्:
      </label>
      <select id="branchSearch">
        <option value="" disabled selected>-- Select Branch --</option>
        <option th:each="branch : ${branches}"
                th:value="${branch.branchCode}"
                th:text="${branch.branchNameNepali}">
        </option>
      </select>
      <button id="branchSearchBtn" type="button">
        <i class="fas fa-magnifying-glass"></i> Search
      </button>
    </div>

    <!-- Results Table -->
    <table id="assetTable" border="1">
      <thead>
        <tr>
          <th>मिती</th>
          <th>सामान</th>
          <th>थान</th>
          <th>रकम</th>
          <th>माग भइ आएको रकम</th>
          <th>आ.प.नं</th>
        </tr>
      </thead>
      <tbody th:replace="fragments/asset-table :: assetTableBodyFragment"></tbody>
    </table>
  </div>

  <!-- Scripts -->
  <script th:src="@{/js/script.js}"></script>
  <script th:src="@{/js/asset-application-script.js}"></script>
  <script>
    document.getElementById("branchSearchBtn").addEventListener("click", function () {
      const branchCode = document.getElementById("branchSearch").value;
      if (!branchCode) return alert("कृपया शाखा छान्नुहोस्।");

      fetch(`/asset-application/search?branchCode=${branchCode}`)
        .then(response => response.text())
        .then(html => {
          document.querySelector("#assetTable tbody").innerHTML = html;
        })
        .catch(err => console.error("Error fetching assets:", err));
    });
  </script>

  <script th:inline="javascript">
    /*<![CDATA[*/
    const branches = /*[[${branches}]]*/ [];
    /*]]>*/
  </script>
</body>
</html>
